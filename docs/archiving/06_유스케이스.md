# PolyPang 유스케이스 (Use Cases)

**목적**: 사용자 관점에서 게임 플레이 시나리오를 정의하고, 각 상황별 시스템 동작을 명확히 함

---

## 목차

1. [UC-01] 방 만들기 및 친구 초대
2. [UC-02] 방 참가하기
3. [UC-03] 로비에서 Ready 하기
4. [UC-04] 게임 시작하기
5. [UC-05] 게임 플레이 (패들 조작)
6. [UC-06] 패들 히트 (공 튕겨내기)
7. [UC-07] 플레이어 탈락 (OUT)
8. [UC-08] 관전자 모드 (이모지 리액션)
9. [UC-09] 게임 종료 및 결과 확인
10. [UC-10] 방 나가기
11. [에러 케이스] 방 참가 실패

---

## [UC-01] 방 만들기 및 친구 초대

### 기본 정보
- **Actor**: 플레이어 (Host)
- **Goal**: 새 방을 만들고 친구를 초대하여 게임을 함께 플레이

### Precondition
- 플레이어가 홈 화면(S01)에 있음
- 네트워크 연결 정상

### Main Flow
1. 플레이어가 "방 만들기" 버튼 클릭
2. 닉네임 입력 (1~10자, 영문/숫자/한글)
3. (선택) 최대 인원 설정 (기본값: 8명)
4. 서버가 6자리 방 코드 생성 (예: `AB3F9K`)
5. 플레이어가 로비 화면(S02)으로 이동
6. 화면 상단에 방 코드 표시
7. 플레이어가 "복사" 버튼으로 방 코드 복사
8. 친구에게 코드 공유 (카카오톡, 문자 등)

### Postcondition
- 방이 생성됨 (Room state: `LOBBY`)
- 플레이어가 Host로 설정됨
- 방 코드가 클립보드에 복사됨

### Alternative Flow
- **3a. 최대 인원 미설정**: 기본값 8명으로 자동 설정

### Exception
- **네트워크 오류**: "서버 연결 실패" 토스트 표시, 홈 화면 유지

---

## [UC-02] 방 참가하기

### 기본 정보
- **Actor**: 플레이어 (Guest)
- **Goal**: 친구가 만든 방에 참가

### Precondition
- 플레이어가 홈 화면(S01)에 있음
- 방 코드를 받음 (예: `AB3F9K`)

### Main Flow
1. 플레이어가 "참가코드 입력" 필드 클릭
2. 6자리 코드 입력 (자동 대문자 변환)
3. 닉네임 입력 (1~10자)
4. "입장" 버튼 클릭
5. 서버가 코드 유효성 검사
6. 방이 존재하고 인원 여유 있음 확인
7. 플레이어가 로비 화면(S02)으로 이동
8. 기존 플레이어들에게 "XXX님이 입장했습니다" 메시지 표시
9. 플레이어 리스트에 추가됨

### Postcondition
- 플레이어가 방에 참가됨
- Player state: `LOBBY_WAIT`
- 모든 플레이어에게 입장 알림 전송

### Exception
- **EC-02a. 코드 오류**: "유효하지 않은 방 코드입니다" 토스트 표시
- **EC-02b. 방 꽉 참**: "방 인원이 가득 찼습니다" 토스트 표시
- **EC-02c. 게임 진행 중**: "게임이 이미 시작되었습니다" 토스트 표시

---

## [UC-03] 로비에서 Ready 하기

### 기본 정보
- **Actor**: 플레이어 (Guest)
- **Goal**: 게임 시작 준비 완료 상태로 전환

### Precondition
- 플레이어가 로비 화면(S02)에 있음
- Player state: `LOBBY_WAIT`

### Main Flow
1. 플레이어가 "Ready" 버튼 클릭
2. Player state: `LOBBY_WAIT` → `LOBBY_READY`
3. 버튼 텍스트: "Ready" → "Cancel Ready"
4. 플레이어 리스트에서 본인 상태가 "READY" 표시로 변경
5. 모든 플레이어에게 상태 변경 알림

### Postcondition
- Player state: `LOBBY_READY`
- Host의 "게임 시작" 버튼 활성화 조건 체크

### Alternative Flow
- **3a. Ready 취소**: "Cancel Ready" 버튼 클릭 → `LOBBY_WAIT`로 복귀

---

## [UC-04] 게임 시작하기

### 기본 정보
- **Actor**: Host
- **Goal**: 로비의 모든 플레이어와 게임 시작

### Precondition
- 플레이어가 Host임
- 로비 화면(S02)에 있음
- 인원 2명 이상
- (선택) 모든 플레이어 Ready (MVP에서는 필수 아님)

### Main Flow
1. Host가 "게임 시작" 버튼 클릭
2. Room state: `LOBBY` → `COUNTDOWN`
3. 모든 플레이어가 카운트다운 오버레이(S03) 표시
4. 화면 중앙에 "3 → 2 → 1 → GO!" 표시 (각 1초)
5. Room state: `COUNTDOWN` → `INGAME`
6. 모든 플레이어 state: `LOBBY_*` → `INGAME_ALIVE`
7. 경기장 초기화:
   - 정N각형 생성 (N = 플레이어 수)
   - 각 플레이어에게 Side 할당 (순서대로)
   - 공을 중앙에서 랜덤 각도로 발사
8. 인게임 화면(S04) 전환

### Postcondition
- Room state: `INGAME`
- 모든 플레이어 `INGAME_ALIVE`
- Arena, Ball, Paddles 초기화 완료
- 게임 루프 시작 (서버 30fps tick)

### Exception
- **EC-04a. 인원 부족**: "최소 2명 이상 필요합니다" 토스트 표시, 버튼 비활성화

---

## [UC-05] 게임 플레이 (패들 조작)

### 기본 정보
- **Actor**: 플레이어 (Alive)
- **Goal**: 패들을 좌우로 움직여 공을 튕겨냄

### Precondition
- Player state: `INGAME_ALIVE`
- 인게임 화면(S04)에 있음

### Main Flow (모바일)
1. 플레이어가 화면 왼쪽 1/3 영역 터치
2. 클라이언트가 서버에 `paddle_move(LEFT)` 전송
3. 서버가 패들 위치 업데이트 (가속도 적용)
4. 서버가 클라이언트에 `paddle_update` 브로드캐스트
5. 클라이언트가 패들 렌더링 (예측 + 서버 보정)
6. 터치 해제 시 `paddle_move(STOP)` 전송
7. 패들이 감속하며 정지

### Main Flow (PC)
1. 플레이어가 'A' 또는 '←' 키 누름
2. (이하 동일)

### Postcondition
- 패들이 Side 위에서 좌우로 이동
- 이동 범위: Side 중심 기준 ±30% (β = 0.6)

### Alternative Flow
- **5a. 오른쪽 이동**: 화면 오른쪽 터치 / 'D' 또는 '→' 키

---

## [UC-06] 패들 히트 (공 튕겨내기)

### 기본 정보
- **Actor**: 시스템 (서버 물리 엔진)
- **Goal**: 공과 패들 충돌 시 반사 처리

### Precondition
- Room state: `INGAME`
- 공이 특정 Side로 이동 중
- 플레이어의 패들이 해당 Side 위에 있음

### Main Flow
1. 서버 물리 엔진이 Ball-Paddle 충돌 감지
2. CollisionResult: `PADDLE_HIT` 리턴
   - `playerId`: 히트한 플레이어
   - `hitPoint`: 충돌 지점
   - `normal`: 법선 벡터
3. 공 속도 5% 증가: `speed *= 1.05`
4. 반사 벡터 계산: `v_new = v - 2*(v·n)*n`
5. `ball.lastHitBy` 갱신
6. 서버가 클라이언트에 `hit_pang` 이벤트 전송
7. 클라이언트가 HIT Pang 이펙트 재생:
   - 충돌 지점에 소형 파티클 (0.2초)
   - 짧은 "팅/핑" 효과음
   - Ball 트레일 강화 (0.3초)

### Postcondition
- 공이 반사되어 반대 방향으로 이동
- 공 속도 증가
- HIT Pang 연출 재생

---

## [UC-07] 플레이어 탈락 (OUT)

### 기본 정보
- **Actor**: 시스템 (서버 물리 엔진)
- **Goal**: 공을 놓친 플레이어를 탈락 처리하고 Arena 재구성

### Precondition
- Room state: `INGAME`
- 공이 특정 Side를 향해 이동
- 해당 플레이어의 패들이 공과 충돌하지 못함

### Main Flow
1. 서버 물리 엔진이 Side 이탈 감지
2. CollisionResult: `SIDE_OUT` 리턴
   - `playerId`: OUT 당한 플레이어
   - `sideIndex`: OUT 발생 Side
3. Player state: `INGAME_ALIVE` → `INGAME_OUT`
4. 서버가 `out_pang` 이벤트 전송
5. 클라이언트가 OUT Pang 연출 재생:
   - OUT Side에서 대형 파티클 폭발 (0.5초)
   - Side 조각이 바깥으로 흩어짐
   - 화면 흔들림 (카메라 쉐이크, 0.2초)
   - "Pang!" 효과음
6. 0.5초 슬로우모션 시작
7. Arena 리메시:
   - 정N각형 → 정(N-1)각형
   - 남은 플레이어들을 새 Side에 재배치
   - 리메시 애니메이션 (0.5초)
8. 슬로우모션 종료, 정상 속도 복귀
9. Player state: `INGAME_OUT` → `SPECTATOR`
10. 플레이어 화면이 관전 모드(S05)로 전환

### Postcondition
- 탈락 플레이어 state: `SPECTATOR`
- Arena N값 감소 (N → N-1)
- 남은 플레이어: `INGAME_ALIVE` 유지
- 게임 루프 계속 진행

### Alternative Flow
- **7a. 마지막 2명 상황**: N=2 → N=1, 게임 종료로 이어짐 (UC-09)

---

## [UC-08] 관전자 모드 (이모지 리액션)

### 기본 정보
- **Actor**: 관전자 (OUT 플레이어)
- **Goal**: 게임을 지켜보며 이모지로 반응

### Precondition
- Player state: `SPECTATOR`
- 관전 화면(S05)에 있음

### Main Flow
1. 플레이어가 하단 EmojiBar에서 이모지 선택 (예: 👍)
2. 클라이언트가 서버에 `send_emoji('👍')` 전송
3. 서버가 모든 플레이어에게 `emoji_reaction` 브로드캐스트
4. 모든 플레이어 화면의 Arena 상단에 이모지 표시
5. 이모지가 1~2초간 떠다니며 페이드아웃

### Postcondition
- 모든 플레이어가 관전자의 반응을 볼 수 있음

### Alternative Flow
- **1a. 다른 이모지**: 😂, 😱, 🔥 등 선택 가능

---

## [UC-09] 게임 종료 및 결과 확인

### 기본 정보
- **Actor**: 시스템
- **Goal**: 최후의 1인이 남으면 게임을 종료하고 결과 표시

### Precondition
- Room state: `INGAME`
- Alive 플레이어 수: 1명

### Main Flow
1. 서버가 게임 종료 조건 감지 (Alive = 1)
2. Room state: `INGAME` → `RESULT`
3. 우승자 확정 (마지막 Alive 플레이어)
4. 랭킹 계산:
   - 1위: 우승자
   - 2~N위: OUT 순서의 역순
5. 게임 통계 계산:
   - 총 게임 시간
   - 총 히트 수
   - 최종 공 속도
   - 플레이어별 히트 수, 생존 시간
6. 서버가 `game_over` 이벤트 전송 (GameResult)
7. 모든 플레이어가 결과 화면(S06)으로 전환
8. 화면 표시:
   - 우승자 강조 (🏆 + 닉네임)
   - 전체 랭킹 리스트
   - 게임 통계 (선택)
   - [다시 하기] [방 나가기] 버튼

### Postcondition
- Room state: `RESULT`
- 모든 플레이어가 결과 화면에 있음

---

## [UC-10] 방 나가기

### 기본 정보
- **Actor**: 플레이어
- **Goal**: 방에서 퇴장하여 홈 화면으로 돌아감

### Precondition
- 플레이어가 로비(S02) 또는 결과 화면(S06)에 있음

### Main Flow
1. 플레이어가 "방 나가기" 버튼 클릭
2. 클라이언트가 서버에 `leave_room` 전송
3. 서버가 플레이어를 방에서 제거
4. 남은 플레이어들에게 `player_left` 이벤트 전송
5. "XXX님이 퇴장했습니다" 메시지 표시
6. 퇴장한 플레이어가 홈 화면(S01)으로 이동

### Postcondition
- 플레이어가 방에서 제거됨
- 홈 화면으로 이동

### Alternative Flow
- **3a. Host 퇴장**: 다른 플레이어가 자동으로 Host로 지정됨
- **3b. 마지막 플레이어 퇴장**: 방이 자동 삭제됨

### Exception
- **인게임 중 퇴장**: 해당 플레이어 즉시 OUT 처리 후 퇴장

---

## [에러 케이스] 방 참가 실패

### EC-02a. 코드 오류

**상황**: 잘못된 방 코드 입력

**시스템 동작**:
1. 서버가 코드 유효성 검사 실패
2. `room_join_failed` 이벤트 전송 (`reason: "INVALID_CODE"`)
3. 클라이언트가 토스트 표시: "유효하지 않은 방 코드입니다"
4. 홈 화면(S01) 유지

### EC-02b. 방 꽉 참

**상황**: 방 최대 인원 도달 (8/8)

**시스템 동작**:
1. 서버가 인원 체크 실패
2. `room_join_failed` 이벤트 전송 (`reason: "ROOM_FULL"`)
3. 클라이언트가 토스트 표시: "방 인원이 가득 찼습니다"
4. 홈 화면(S01) 유지

### EC-02c. 게임 진행 중

**상황**: 이미 게임이 시작된 방 (Room state: `INGAME` 또는 `COUNTDOWN`)

**시스템 동작**:
1. 서버가 Room state 체크 실패
2. `room_join_failed` 이벤트 전송 (`reason: "GAME_IN_PROGRESS"`)
3. 클라이언트가 토스트 표시: "게임이 이미 시작되었습니다"
4. 홈 화면(S01) 유지

---

## 유스케이스 맵 (흐름도)

```
[홈 화면 S01]
    ↓
    ├─→ [방 만들기 UC-01] ─→ [로비 S02]
    │                           ↓
    └─→ [방 참가 UC-02] ────→ [로비 S02]
                                ↓
                          [Ready UC-03]
                                ↓
                          [게임 시작 UC-04]
                                ↓
                          [카운트다운 S03]
                                ↓
                          [인게임 S04]
                          ↓         ↓
                    [패들 조작]  [패들 히트]
                      UC-05      UC-06
                          ↓
                      [OUT UC-07]
                          ↓
                    [관전 모드 UC-08]
                          ↓
                    [게임 종료 UC-09]
                          ↓
                    [결과 화면 S06]
                          ↓
                    [방 나가기 UC-10]
                          ↓
                    [홈 화면 S01]
```

---

## 다음 단계

- **07_시퀀스다이어그램.md**: 각 유스케이스의 상세 메시지 흐름 (클라↔서버)
- **08_API명세서.md**: Socket 이벤트 페이로드 상세 스펙
