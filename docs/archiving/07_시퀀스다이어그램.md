# PolyPang μ‹ν€€μ¤ λ‹¤μ΄μ–΄κ·Έλ¨

**λ©μ **: μ£Όμ” ν”λ΅μ°μ ν΄λΌμ΄μ–ΈνΈ-μ„λ²„ λ©”μ‹μ§€ νλ¦„μ„ μ‹κ°ν™”ν•μ—¬ κ°λ° μ‹ κµ¬ν„ κ°€μ΄λ“λ΅ ν™μ©

**ν‘κΈ°λ²•**: Mermaid μ‹ν€€μ¤ λ‹¤μ΄μ–΄κ·Έλ¨

---

## λ©μ°¨

1. [SEQ-01] λ°© μƒμ„± λ° μ°Έκ°€
2. [SEQ-02] λ΅λΉ„μ—μ„ κ²μ„ μ‹μ‘
3. [SEQ-03] ν¨λ“¤ μ…λ ¥ λ° ννΈ
4. [SEQ-04] OUT νμ • λ° Arena λ¦¬λ©”μ‹
5. [SEQ-05] κ²μ„ μΆ…λ£ λ° κ²°κ³Ό

---

## [SEQ-01] λ°© μƒμ„± λ° μ°Έκ°€

### 1.1 λ°© μƒμ„± (Host)

```mermaid
sequenceDiagram
    actor Host as Host (ν΄λΌμ΄μ–ΈνΈ)
    participant Server as μ„λ²„
    
    Note over Host: ν™ ν™”λ©΄ (S01)
    Host->>Host: "λ°© λ§λ“¤κΈ°" λ²„νΌ ν΄λ¦­
    Host->>Host: λ‹‰λ„¤μ„ μ…λ ¥ "illuni"
    
    Host->>+Server: create_room("illuni", maxPlayers=8)
    
    Server->>Server: Room μƒμ„±
    Server->>Server: 6μλ¦¬ μ½”λ“ μƒμ„± "AB3F9K"
    Server->>Server: Host μ„¤μ •
    
    Server-->>-Host: room_created("AB3F9K")
    Server->>Host: room_joined(Room)
    
    Host->>Host: λ΅λΉ„ ν™”λ©΄ (S02) μ΄λ™
    Host->>Host: λ°© μ½”λ“ ν‘μ‹ "AB3F9K"
    
    Note over Host: μΉκµ¬μ—κ² μ½”λ“ κ³µμ 
```

### 1.2 λ°© μ°Έκ°€ (Guest)

```mermaid
sequenceDiagram
    actor Guest as Guest (ν΄λΌμ΄μ–ΈνΈ)
    actor Host as Host (ν΄λΌμ΄μ–ΈνΈ)
    participant Server as μ„λ²„
    
    Note over Guest: ν™ ν™”λ©΄ (S01)
    Guest->>Guest: μ½”λ“ μ…λ ¥ "AB3F9K"
    Guest->>Guest: λ‹‰λ„¤μ„ μ…λ ¥ "guest1"
    
    Guest->>+Server: join_room("AB3F9K", "guest1")
    
    Server->>Server: μ½”λ“ μ ν¨μ„± κ²€μ‚¬ β“
    Server->>Server: μΈμ› μ²΄ν¬ (2/8) β“
    Server->>Server: ν”λ μ΄μ–΄ μ¶”κ°€
    
    Server-->>-Guest: room_joined(Room)
    Server->>Host: player_joined(guest1)
    
    Guest->>Guest: λ΅λΉ„ ν™”λ©΄ (S02) μ΄λ™
    Host->>Host: "guest1λ‹μ΄ μ…μ¥ν–μµλ‹λ‹¤" ν† μ¤νΈ ν‘μ‹
    Host->>Host: ν”λ μ΄μ–΄ λ¦¬μ¤νΈ κ°±μ‹ 
```

### 1.3 λ°© μ°Έκ°€ μ‹¤ν¨ (μ—λ¬ μΌ€μ΄μ¤)

```mermaid
sequenceDiagram
    actor Guest as Guest (ν΄λΌμ΄μ–ΈνΈ)
    participant Server as μ„λ²„
    
    Guest->>+Server: join_room("INVALID", "guest1")
    
    Server->>Server: μ½”λ“ μ ν¨μ„± κ²€μ‚¬ β—
    
    Server-->>-Guest: room_join_failed("INVALID_CODE")
    
    Guest->>Guest: "μ ν¨ν•μ§€ μ•μ€ λ°© μ½”λ“μ…λ‹λ‹¤" ν† μ¤νΈ
    Guest->>Guest: ν™ ν™”λ©΄ (S01) μ μ§€
```

---

## [SEQ-02] λ΅λΉ„μ—μ„ κ²μ„ μ‹μ‘

### 2.1 Ready μƒνƒ λ³€κ²½

```mermaid
sequenceDiagram
    actor Guest as Guest (ν΄λΌμ΄μ–ΈνΈ)
    actor Host as Host (ν΄λΌμ΄μ–ΈνΈ)
    participant Server as μ„λ²„
    
    Note over Guest,Host: λ΅λΉ„ ν™”λ©΄ (S02)
    
    Guest->>+Server: toggle_ready()
    
    Server->>Server: Player state: LOBBY_WAIT β†’ LOBBY_READY
    
    Server->>Guest: player_ready_changed(guest1, true)
    Server->>-Host: player_ready_changed(guest1, true)
    
    Guest->>Guest: λ²„νΌ: "Ready" β†’ "Cancel Ready"
    Host->>Host: ν”λ μ΄μ–΄ λ¦¬μ¤νΈ κ°±μ‹  (guest1 READY)
    Host->>Host: "κ²μ„ μ‹μ‘" λ²„νΌ ν™μ„±ν™” μ²΄ν¬
```

### 2.2 κ²μ„ μ‹μ‘ (Host)

```mermaid
sequenceDiagram
    actor Host as Host (ν΄λΌμ΄μ–ΈνΈ)
    actor Guest as Guest (ν΄λΌμ΄μ–ΈνΈ)
    participant Server as μ„λ²„
    
    Note over Host,Guest: λ΅λΉ„ ν™”λ©΄ (S02)
    
    Host->>+Server: start_game()
    
    Server->>Server: Room state: LOBBY β†’ COUNTDOWN
    Server->>Server: μΉ΄μ΄νΈλ‹¤μ΄ νƒ€μ΄λ¨Έ μ‹μ‘
    
    Server->>Host: game_countdown(3)
    Server->>Guest: game_countdown(3)
    
    Host->>Host: μΉ΄μ΄νΈλ‹¤μ΄ μ¤λ²„λ μ΄ (S03)
    Guest->>Guest: μΉ΄μ΄νΈλ‹¤μ΄ μ¤λ²„λ μ΄ (S03)
    
    Note over Server: 1μ΄ λ€κΈ°
    
    Server->>Host: game_countdown(2)
    Server->>Guest: game_countdown(2)
    
    Note over Server: 1μ΄ λ€κΈ°
    
    Server->>Host: game_countdown(1)
    Server->>Guest: game_countdown(1)
    
    Note over Server: 1μ΄ λ€κΈ°
    Server->>Server: Room state: COUNTDOWN β†’ INGAME
    Server->>Server: Arena μ΄κΈ°ν™” (μ •Nκ°ν•)
    Server->>Server: Ball μ΄κΈ°ν™” (μ¤‘μ•™, λλ¤ κ°λ„)
    Server->>Server: Paddles μ΄κΈ°ν™”
    Server->>Server: κ²μ„ λ£¨ν”„ μ‹μ‘ (30fps tick)
    
    Server->>Host: game_started(GameState)
    Server->>-Guest: game_started(GameState)
    
    Host->>Host: μΈκ²μ„ ν™”λ©΄ (S04)
    Guest->>Guest: μΈκ²μ„ ν™”λ©΄ (S04)
    
    Note over Host,Guest: κ²μ„ μ§„ν–‰ μ¤‘
```

---

## [SEQ-03] ν¨λ“¤ μ…λ ¥ λ° ννΈ

### 3.1 ν¨λ“¤ μ΄λ™ (μ…λ ¥ μ²λ¦¬)

```mermaid
sequenceDiagram
    actor Player as Player (ν΄λΌμ΄μ–ΈνΈ)
    participant Server as μ„λ²„
    
    Note over Player: μΈκ²μ„ ν™”λ©΄ (S04)
    
    Player->>Player: ν™”λ©΄ μ™Όμ½ ν„°μΉ (λλ” 'A' ν‚¤)
    Player->>+Server: paddle_move(LEFT)
    
    Server->>Server: Paddle κ°€μ†λ„ μ μ©
    Server->>Server: Paddle μ„μΉ μ—…λ°μ΄νΈ
    Server->>Server: μ΄λ™ λ²”μ„ μ²΄ν¬
    
    Server->>-Player: paddle_update(playerId, { position, velocity })
    
    Player->>Player: ν¨λ“¤ λ λ”λ§ (μμΈ΅ + μ„λ²„ λ³΄μ •)
    
    Note over Player: ν„°μΉ ν•΄μ 
    
    Player->>+Server: paddle_move(STOP)
    
    Server->>Server: Paddle κ°μ† μ μ©
    Server->>-Player: paddle_update(playerId, { velocity })
    
    Player->>Player: ν¨λ“¤ κ°μ† λ λ”λ§
```

### 3.2 κ³µ-ν¨λ“¤ μ¶©λ (HIT Pang)

```mermaid
sequenceDiagram
    participant Server as μ„λ²„
    actor P1 as Player1 (ν΄λΌμ΄μ–ΈνΈ)
    actor P2 as Player2 (ν΄λΌμ΄μ–ΈνΈ)
    
    Note over Server: κ²μ„ λ£¨ν”„ (30fps tick)
    
    Server->>Server: Ball μ„μΉ μ—…λ°μ΄νΈ
    Server->>Server: μ¶©λ κ°μ§€: PADDLE_HIT
    Server->>Server: playerId: P1
    Server->>Server: λ°μ‚¬ λ²΅ν„° κ³„μ‚°
    Server->>Server: μ†λ„ 5% μ¦κ°€
    Server->>Server: ball.lastHitBy = P1
    
    Server->>P1: hit_pang(CollisionResult)
    Server->>P2: hit_pang(CollisionResult)
    
    P1->>P1: HIT Pang μ΄ν™νΈ μ¬μƒ
    P1->>P1: - μ†ν• νν‹°ν΄ (0.2μ΄)
    P1->>P1: - "ν…/ν•‘" ν¨κ³Όμ
    P1->>P1: - Ball νΈλ μΌ κ°•ν™”
    
    P2->>P2: HIT Pang μ΄ν™νΈ μ¬μƒ
    
    Server->>P1: ball_update({ position, velocity, speed })
    Server->>P2: ball_update({ position, velocity, speed })
    
    P1->>P1: κ³µ λ λ”λ§ (λ°μ‚¬ ν›„)
    P2->>P2: κ³µ λ λ”λ§ (λ°μ‚¬ ν›„)
```

---

## [SEQ-04] OUT νμ • λ° Arena λ¦¬λ©”μ‹

### 4.1 OUT νμ •

```mermaid
sequenceDiagram
    participant Server as μ„λ²„
    actor P1 as Player1 (ν΄λΌμ΄μ–ΈνΈ)
    actor P2 as Player2 (OUT)
    actor P3 as Player3 (ν΄λΌμ΄μ–ΈνΈ)
    
    Note over Server: κ²μ„ λ£¨ν”„ tick
    
    Server->>Server: Ball μ„μΉ μ—…λ°μ΄νΈ
    Server->>Server: μ¶©λ κ°μ§€: SIDE_OUT
    Server->>Server: playerId: P2, sideIndex: 1
    Server->>Server: Player state: INGAME_ALIVE β†’ INGAME_OUT
    
    Server->>P1: out_pang(P2, sideIndex=1)
    Server->>P2: out_pang(P2, sideIndex=1)
    Server->>P3: out_pang(P2, sideIndex=1)
    
    P1->>P1: OUT Pang μ΄ν™νΈ μ¬μƒ
    P1->>P1: - λ€ν• νν‹°ν΄ ν­λ°
    P1->>P1: - Side μ΅°κ° ν©μ–΄μ§
    P1->>P1: - μΉ΄λ©”λΌ μ‰μ΄ν¬ (0.2μ΄)
    P1->>P1: - "Pang!" ν¨κ³Όμ
    
    P2->>P2: OUT Pang μ΄ν™νΈ μ¬μƒ
    P3->>P3: OUT Pang μ΄ν™νΈ μ¬μƒ
    
    Server->>P1: player_out(P2, "MISS")
    Server->>P2: player_out(P2, "MISS")
    Server->>P3: player_out(P2, "MISS")
    
    P2->>P2: "OUT!" UI ν‘μ‹
    
    Note over Server: 0.5μ΄ μ¬λ΅μ°λ¨μ… μ‹μ‘
```

### 4.2 Arena λ¦¬λ©”μ‹

```mermaid
sequenceDiagram
    participant Server as μ„λ²„
    actor P1 as Player1 (ν΄λΌμ΄μ–ΈνΈ)
    actor P2 as Player2 (κ΄€μ „μ)
    actor P3 as Player3 (ν΄λΌμ΄μ–ΈνΈ)
    
    Note over Server: μ¬λ΅μ°λ¨μ… μ§„ν–‰ μ¤‘
    
    Server->>Server: Arena μ¬κ³„μ‚°
    Server->>Server: - μ •3κ°ν• β†’ μ •2κ°ν•
    Server->>Server: - P1, P3λ§ Side μ¬ν• λ‹Ή
    Server->>Server: - vertices, sides κ°±μ‹ 
    
    Server->>P1: arena_remesh_start(newArena)
    Server->>P2: arena_remesh_start(newArena)
    Server->>P3: arena_remesh_start(newArena)
    
    P1->>P1: λ¦¬λ©”μ‹ μ• λ‹λ©”μ΄μ… (0.5μ΄)
    P1->>P1: - Side μ΄λ™ (Ease-in-out)
    P1->>P1: - OUT Side μ‚¬λΌμ§
    
    P2->>P2: λ¦¬λ©”μ‹ μ• λ‹λ©”μ΄μ…
    P3->>P3: λ¦¬λ©”μ‹ μ• λ‹λ©”μ΄μ…
    
    Note over Server: 0.5μ΄ ν›„
    
    Server->>P1: arena_remesh_complete()
    Server->>P2: arena_remesh_complete()
    Server->>P3: arena_remesh_complete()
    
    Server->>Server: Player state: INGAME_OUT β†’ SPECTATOR
    
    P1->>P1: μ¬λ΅μ°λ¨μ… μΆ…λ£, μ •μƒ μ†λ„
    P2->>P2: κ΄€μ „ λ¨λ“ (S05) μ „ν™
    P2->>P2: - μ…λ ¥ UI μ κ±°
    P2->>P2: - EmojiBar ν‘μ‹
    P3->>P3: μ¬λ΅μ°λ¨μ… μΆ…λ£, μ •μƒ μ†λ„
    
    Note over P1,P3: κ²μ„ κ³„μ† μ§„ν–‰
```

---

## [SEQ-05] κ²μ„ μΆ…λ£ λ° κ²°κ³Ό

### 5.1 κ²μ„ μΆ…λ£ (μµν›„μ 1μΈ)

```mermaid
sequenceDiagram
    participant Server as μ„λ²„
    actor Winner as Winner (ν΄λΌμ΄μ–ΈνΈ)
    actor P2 as Player2 (κ΄€μ „μ)
    actor P3 as Player3 (κ΄€μ „μ)
    
    Note over Server: P3 OUT λ°μƒ
    Note over Server: Alive ν”λ μ΄μ–΄: Winnerλ§ λ‚¨μ
    
    Server->>Server: κ²μ„ μΆ…λ£ μ΅°κ±΄ κ°μ§€
    Server->>Server: Room state: INGAME β†’ RESULT
    Server->>Server: winnerId = Winner
    Server->>Server: λ­ν‚Ή κ³„μ‚°
    Server->>Server: - 1μ„: Winner
    Server->>Server: - 2μ„: P3 (λ§μ§€λ§‰ OUT)
    Server->>Server: - 3μ„: P2 (λ¨Όμ € OUT)
    Server->>Server: κ²μ„ ν†µκ³„ κ³„μ‚°
    
    Server->>Winner: game_over(GameResult)
    Server->>P2: game_over(GameResult)
    Server->>P3: game_over(GameResult)
    
    Winner->>Winner: κ²°κ³Ό ν™”λ©΄ (S06) μ΄λ™
    Winner->>Winner: - μ°μΉμ κ°•μ΅° (π† Winner)
    Winner->>Winner: - λ­ν‚Ή λ¦¬μ¤νΈ ν‘μ‹
    Winner->>Winner: - κ²μ„ ν†µκ³„ ν‘μ‹
    Winner->>Winner: - [λ‹¤μ‹ ν•κΈ°] [λ°© λ‚κ°€κΈ°] λ²„νΌ
    
    P2->>P2: κ²°κ³Ό ν™”λ©΄ (S06) μ΄λ™
    P3->>P3: κ²°κ³Ό ν™”λ©΄ (S06) μ΄λ™
```

### 5.2 λ‹¤μ‹ ν•κΈ°

```mermaid
sequenceDiagram
    actor Host as Host (ν΄λΌμ΄μ–ΈνΈ)
    actor Guest as Guest (ν΄λΌμ΄μ–ΈνΈ)
    participant Server as μ„λ²„
    
    Note over Host,Guest: κ²°κ³Ό ν™”λ©΄ (S06)
    
    Host->>+Server: leave_room() & create_room()
    
    Note over Server: λλ” λ³„λ„ "restart" μ΄λ²¤νΈ
    
    Server->>Server: Room state: RESULT β†’ LOBBY
    Server->>Server: ν”λ μ΄μ–΄ μƒνƒ μ΄κΈ°ν™”
    Server->>Server: - Player state: SPECTATOR β†’ LOBBY_WAIT
    
    Server->>Host: room_joined(Room)
    Server->>-Guest: room_joined(Room)
    
    Host->>Host: λ΅λΉ„ ν™”λ©΄ (S02) μ΄λ™
    Guest->>Guest: λ΅λΉ„ ν™”λ©΄ (S02) μ΄λ™
    
    Note over Host,Guest: λ‹¤μ‹ Ready & Start κ°€λ¥
```

---

## μ „μ²΄ ν”λ΅μ° μ”μ•½

```mermaid
sequenceDiagram
    actor Client as ν΄λΌμ΄μ–ΈνΈ
    participant Server as μ„λ²„
    
    Note over Client,Server: 1. λ°© μƒμ„±/μ°Έκ°€
    Client->>Server: create_room / join_room
    Server->>Client: room_created / room_joined
    
    Note over Client,Server: 2. λ΅λΉ„
    Client->>Server: toggle_ready
    Server->>Client: player_ready_changed
    Client->>Server: start_game (Host)
    Server->>Client: game_countdown (3, 2, 1)
    
    Note over Client,Server: 3. κ²μ„ μ‹μ‘
    Server->>Client: game_started(GameState)
    
    Note over Client,Server: 4. κ²μ„ λ£¨ν”„ (30fps)
    loop λ§¤ ν‹± (33ms)
        Client->>Server: paddle_move(direction)
        Server->>Server: λ¬Όλ¦¬ μ‹λ®¬λ μ΄μ…
        Server->>Client: game_state_update
        
        alt ν¨λ“¤ ννΈ
            Server->>Client: hit_pang
        else OUT νμ •
            Server->>Client: out_pang, player_out
            Server->>Client: arena_remesh_start
            Server->>Client: arena_remesh_complete
        end
    end
    
    Note over Client,Server: 5. κ²μ„ μΆ…λ£
    Server->>Client: game_over(GameResult)
    
    Note over Client,Server: 6. λ°© λ‚κ°€κΈ°
    Client->>Server: leave_room
    Server->>Client: player_left
```

---

## λ©”μ‹μ§€ λΉλ„ λ° μ°μ„ μμ„

| μ΄λ²¤νΈ | λ°©ν–¥ | λΉλ„ | μ°μ„ μμ„ | λΉ„κ³  |
|--------|------|------|----------|------|
| `paddle_move` | Cβ†’S | μ…λ ¥ μ‹λ§λ‹¤ | High | μ…λ ¥ μ§€μ—° μµμ†ν™” |
| `game_state_update` | Sβ†’C | 30fps | High | κ²μ„ λ£¨ν”„ ν•µμ‹¬ |
| `ball_update` | Sβ†’C | 30fps | High | κ²μ„ λ£¨ν”„ ν•µμ‹¬ |
| `paddle_update` | Sβ†’C | ν•„μ” μ‹ | Medium | μƒνƒ λ³€κ²½ μ‹λ§ |
| `hit_pang` | Sβ†’C | μ¶©λ μ‹ | Low | μ—°μ¶μ© |
| `out_pang` | Sβ†’C | OUT μ‹ | High | μ¤‘μ” μ΄λ²¤νΈ |
| `player_ready_changed` | Sβ†’C | Ready μ‹ | Low | λ΅λΉ„ |
| `game_countdown` | Sβ†’C | 1fps Γ— 3μ΄ | Medium | μ‹μ‘ μ—°μ¶ |

---

## λ‹¤μ λ‹¨κ³„

- **08_APIλ…μ„Έμ„.md**: κ° Socket μ΄λ²¤νΈμ νμ΄λ΅λ“ μƒμ„Έ μ¤ν™
- **μ‹¤μ  κµ¬ν„**: TypeScript νƒ€μ… + μ„λ²„/ν΄λΌμ΄μ–ΈνΈ μ΄λ²¤νΈ ν•Έλ“¤λ¬ μ‘μ„±
