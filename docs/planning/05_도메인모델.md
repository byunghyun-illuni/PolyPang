# PolyPang 도메인 모델 정의서

**목적**: 클라이언트/서버 간 공유할 TypeScript 타입 정의 명세

**원칙**:
1. 모든 게임 엔티티는 명확한 타입 정의
2. 클라이언트/서버 타입 일관성 유지
3. Socket 이벤트 페이로드 타입 안정성
4. 물리 계산 타입 정확성

---

## 1. 코어 타입 (Core Types)

### 1.1 기본 Enum

```typescript
// types/enums.ts

/**
 * 방 상태
 */
export enum RoomState {
  LOBBY = 'LOBBY',           // 로비 (인원 모집 중)
  COUNTDOWN = 'COUNTDOWN',   // 카운트다운 (3초)
  INGAME = 'INGAME',         // 게임 진행 중
  RESULT = 'RESULT',         // 결과 화면
}

/**
 * 플레이어 상태
 */
export enum PlayerState {
  LOBBY_WAIT = 'LOBBY_WAIT',       // 로비 대기 (Ready 전)
  LOBBY_READY = 'LOBBY_READY',     // Ready 상태
  INGAME_ALIVE = 'INGAME_ALIVE',   // 게임 중 생존
  INGAME_OUT = 'INGAME_OUT',       // OUT 판정 직후 (연출 중)
  SPECTATOR = 'SPECTATOR',         // 관전자 모드
  DISCONNECTED = 'DISCONNECTED',   // 연결 끊김
}

/**
 * 패들 입력 방향
 */
export enum PaddleDirection {
  LEFT = 'LEFT',
  RIGHT = 'RIGHT',
  STOP = 'STOP',
}

/**
 * 충돌 타입
 * 
 * 물리 엔진이 매 틱마다 "공이 무엇과 상호작용했는가"를 분류하는 타입
 */
export enum CollisionType {
  NONE = 'NONE',                   // 충돌 없음 (자유 이동)
  PADDLE_HIT = 'PADDLE_HIT',       // 패들 히트 → 반사 + 속도 증가 + HIT Pang
  WALL_REFLECT = 'WALL_REFLECT',   // 벽 반사 (패들 없는 Side 구간)
  SIDE_OUT = 'SIDE_OUT',           // Side 이탈 (미스 판정) → OUT Pang
}
```

### 1.2 기본 인터페이스

```typescript
// types/primitives.ts

/**
 * 2D 벡터
 */
export interface Vector2D {
  x: number;
  y: number;
}

/**
 * 속도 벡터
 */
export interface Velocity {
  vx: number;
  vy: number;
}

/**
 * 색상 (Hex)
 */
export type Color = string; // '#FF5733'

/**
 * 플레이어 ID (UUID)
 */
export type PlayerId = string;

/**
 * 방 코드 (6자리 영문+숫자)
 */
export type RoomCode = string; // 'AB3F9K'

/**
 * 타임스탬프 (ISO 8601)
 */
export type Timestamp = string; // '2024-01-01T00:00:00.000Z'
```

---

## 2. 게임 엔티티 (Game Entities)

### 2.1 Player (플레이어)

```typescript
// types/player.types.ts

export interface Player {
  /** 플레이어 고유 ID (UUID) */
  userId: PlayerId;

  /** 닉네임 (1~10자) */
  nickname: string;

  /** 현재 플레이어 상태 */
  state: PlayerState;

  /** Side 인덱스 (0-based, INGAME 시에만 할당) */
  sideIndex?: number;

  /** 플레이어 고유 색상 (Hex) */
  color: Color;

  /** Ready 상태 (LOBBY에서만 사용) */
  isReady: boolean;

  /** 호스트 여부 */
  isHost: boolean;

  /** 접속 시간 */
  joinedAt: Timestamp;

  /** 마지막 활동 시간 (핑퐁용) */
  lastActiveAt: Timestamp;
}

/**
 * 플레이어 생성 DTO
 */
export interface CreatePlayerDto {
  nickname: string;
  color?: Color; // 미지정 시 서버에서 자동 할당
}

/**
 * 플레이어 랭킹 정보
 */
export interface PlayerRanking {
  player: Player;
  rank: number; // 1~N
  survivalTime: number; // 생존 시간 (초)
  outReason?: string; // 탈락 사유
}
```

---

## 3. 물리 & 충돌 (Physics & Collision)

### 3.1 충돌 판정 결과 (개선된 버전)

```typescript
// types/collision.types.ts

/**
 * 충돌 판정 결과 (Discriminated Union)
 * 
 * 서버 물리 엔진이 매 틱마다 리턴하는 "공이 무엇과 상호작용했는가" 결과
 */
export type CollisionResult =
  | {
      type: CollisionType.NONE;
    }
  | {
      type: CollisionType.PADDLE_HIT;
      playerId: PlayerId;      // 어느 플레이어 패들인가
      sideIndex: number;       // 어느 Side인가
      hitPoint: Vector2D;      // 충돌 지점
      normal: Vector2D;        // 법선 벡터
    }
  | {
      type: CollisionType.WALL_REFLECT;
      sideIndex: number;       // 어느 Side 벽인가
      hitPoint: Vector2D;      // 반사 지점
      normal: Vector2D;        // 법선 벡터
    }
  | {
      type: CollisionType.SIDE_OUT;
      playerId: PlayerId;      // OUT 당한 플레이어
      sideIndex: number;       // OUT 발생 Side
    };

/**
 * 반사 계산 결과
 */
export interface ReflectionResult {
  /** 반사 후 속도 */
  velocity: Velocity;

  /** 반사 각도 (라디안) */
  angle: number;

  /** 속도 크기 (스칼라) */
  speed: number;
}
```

### 3.2 물리 계산 파라미터

```typescript
// types/physics.types.ts

/**
 * 정N각형 계산 파라미터
 */
export interface PolygonParams {
  /** 변의 개수 (플레이어 수) */
  n: number;

  /** 반지름 */
  radius: number;

  /** 회전 각도 (라디안, 기본: -π/2 = 12시 방향) */
  rotation?: number;
}

/**
 * 선분
 */
export interface LineSegment {
  start: Vector2D;
  end: Vector2D;
}

/**
 * 원 (Ball 등)
 */
export interface Circle {
  center: Vector2D;
  radius: number;
}
```

---

## 4. 주요 타입 요약

### 핵심 엔티티
- **Player**: 플레이어 정보 및 상태 (6가지 상태)
- **Room**: 방 정보 및 게임 세션
- **Arena**: 정N각형 경기장 및 Side 정보
- **Ball**: 공 물리 속성
- **Paddle**: 패들 위치 및 이동
- **GameState**: 전체 게임 상태

### 물리 & 충돌
- **CollisionType**: 충돌 종류 (NONE, PADDLE_HIT, WALL_REFLECT, SIDE_OUT)
- **CollisionResult**: Discriminated Union으로 누구/어디와 충돌했는지 상세 정보
- **ReflectionResult**: 반사 계산 결과

### Socket 이벤트
- **ServerToClientEvents**: 서버 → 클라이언트 40+ 이벤트
- **ClientToServerEvents**: 클라이언트 → 서버 이벤트

---

## 5. CollisionType 동작 상세

### PADDLE_HIT (패들 히트)
**발생 조건**: 공이 플레이어 패들과 충돌
**처리**:
1. 반사각 계산 (법선 벡터 기준)
2. 속도 5% 증가 (`speed *= 1.05`)
3. HIT Pang 이펙트 (소형 파티클)
4. `ball.lastHitBy` 갱신
5. 타격음 재생 ("팅/핑")

### WALL_REFLECT (벽 반사)
**발생 조건**: 공이 패들 없는 Side 구간 또는 정점에 충돌
**처리**:
1. 반사각 계산 (법선 벡터 기준)
2. 속도 유지 (증가 없음)
3. (선택) 미세한 벽 튕김 효과음

### SIDE_OUT (사이드 이탈)
**발생 조건**: 공이 Side를 통과해서 경기장 밖으로 이탈 (패들 미스)
**처리**:
1. 해당 플레이어 OUT 판정
2. OUT Pang 이펙트 (대형 파티클 + 카메라 쉐이크)
3. Arena 리메시 (정N → 정(N-1)각형)
4. 0.5초 슬로우모션
5. 탈락음 재생 ("Pang!")

---

## 6. 타입 사용 예시

### 서버 물리 엔진

```typescript
// server/src/game/PhysicsEngine.ts
class PhysicsEngine {
  tick(): void {
    // 공 이동
    this.updateBallPosition();

    // 충돌 감지
    const collision = this.detectCollision();

    // 타입별 처리
    switch (collision.type) {
      case CollisionType.PADDLE_HIT:
        this.handlePaddleHit(collision.playerId, collision.hitPoint);
        this.increaseBallSpeed();
        this.emitHitPang(collision.hitPoint);
        break;

      case CollisionType.WALL_REFLECT:
        this.reflectBall(collision.normal);
        break;

      case CollisionType.SIDE_OUT:
        this.handlePlayerOut(collision.playerId, collision.sideIndex);
        this.emitOutPang(collision.sideIndex);
        this.remeshArena();
        break;

      case CollisionType.NONE:
        // 아무 처리 없음
        break;
    }
  }

  detectCollision(): CollisionResult {
    // 충돌 감지 로직...
    // 예시: 패들 히트 감지
    if (this.checkPaddleCollision(ball, paddle)) {
      return {
        type: CollisionType.PADDLE_HIT,
        playerId: paddle.playerId,
        sideIndex: paddle.sideIndex,
        hitPoint: { x: ball.position.x, y: ball.position.y },
        normal: side.normal,
      };
    }

    // Side 이탈 감지
    if (this.checkSideOut(ball, side)) {
      return {
        type: CollisionType.SIDE_OUT,
        playerId: side.playerId,
        sideIndex: side.index,
      };
    }

    return { type: CollisionType.NONE };
  }
}
```

### 클라이언트 이벤트 처리

```typescript
// client/src/hooks/useSocketEvents.ts
socket.on('hit_pang', (collision: CollisionResult) => {
  if (collision.type === CollisionType.PADDLE_HIT) {
    // HIT Pang 파티클 재생
    playParticleEffect({
      type: 'hit_pang',
      position: collision.hitPoint,
      color: getPlayerColor(collision.playerId),
    });

    // 효과음
    playSound('hit_pang');
  }
});

socket.on('out_pang', (userId: PlayerId, sideIndex: number) => {
  // OUT Pang 파티클 재생
  playParticleEffect({
    type: 'out_pang',
    position: getSideCenter(sideIndex),
    color: getPlayerColor(userId),
  });

  // 카메라 쉐이크
  cameraShake({ intensity: 5, duration: 0.2 });

  // 효과음
  playSound('out_pang');
});
```

---

## 7. 다음 단계

1. **타입 파일 생성**: `client/src/types/` 폴더에 실제 TypeScript 파일 작성
2. **물리 엔진 구현**: 충돌 감지 로직 작성 (`physics/collision.ts`)
3. **Socket 이벤트 구현**: 서버/클라이언트 이벤트 핸들러 작성

---

**참고**: 더 상세한 타입 정의는 실제 개발 중 `client/src/types/` 폴더에 추가합니다.
